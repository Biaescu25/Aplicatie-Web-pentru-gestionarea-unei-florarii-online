{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flower Joy</title>
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap" rel="stylesheet"> <!-- Indie Flower font -->

    <link href="{% static 'output.css' %}" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>

<style>
  
.font-dancing {
    font-family: 'Dancing Script', cursive;
}
.font-indie {
    font-family: 'Indie Flower', cursive;
}
.glass {
    position: absolute;
    top: 55%;
    left: -50%;
    transform: translateY(-50%);
    width: 30%;
    height: 40%;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    backdrop-filter: blur(10px);
    transition: left 0.5s ease-in-out;
}
.glass.active {
    left: 10%;
}

/* Remove number input arrows */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type="number"] {
    -moz-appearance: textfield;
}



/* price ranger */

    /* Hide default range styling */
    input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        position: absolute;
        background: transparent;
        pointer-events: none;
        z-index: 2;
        left:0;
    }

    /* Custom track (hidden default) */
    input[type="range"]::-webkit-slider-runnable-track {
        height: 2px;
    }

    /* Custom thumb styling (Centered) */
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: white;
        border: 3px solid;
        border-radius: 50%;
        cursor: pointer;
        pointer-events: auto;
        position: relative;
        z-index: 3;
        transform: translateY(-40%);
    }

    input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: white;
        border: 3px solid ;
        border-radius: 50%;
        cursor: pointer;
        pointer-events: auto;
        z-index: 3;
        transform: translateY(-40%);
    }

    /* Centering the range input itself */
    .slider-container {
        position: relative;
        height: 10px; /* Adjust height to fit thumb */
    }

</style>

<body class="bg-gray-50 dark:bg-base-100 font-serif min-h-screen flex flex-col transition-colors duration-300">

    <!-- Navbar -->
    {% include 'partials/navbar.html' %}  

    <!-- Main Content -->
    <main class="flex-grow h-full">
        {% block content %}
        {% endblock %}
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4 flex justify-between">
            <p>&copy; 2025 FloralShop. Toate drepturile rezervate.</p>
            <div>
                <a href="#" class="text-gray-400 mx-2"></a>
                <a href="#" class="text-gray-400 mx-2"></a>
                <a href="#" class="text-gray-400 mx-2"></a>
            </div>
        </div>
    </footer>

</body>

<meta name="stripe-key" content="{{ stripe_public_key }}">

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("pk_test_51R8NtNRsvYugeMjUdh0qycRIsQ6qcSW2dfu2eZQiPpJ4Jf4k0xZf6AWkIkg1aNxnlC8mVDFlu9LribT35lEW2oIw00uXLxKHes");
    let card = null;

    document.body.addEventListener('htmx:afterSwap', function (evt) {
    const target = evt.detail.target;

    if (target.querySelector('#card-element') && stripe) {
        if (document.querySelector('#payment-form').dataset.initialized === "true") return;
        document.querySelector('#payment-form').dataset.initialized = "true";

        const elements = stripe.elements();
        card = elements.create("card");
        card.mount("#card-element");

        const form = document.querySelector("#payment-form");
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            stripe.createToken(card).then(function (result) {
                if (result.error) {
                    document.getElementById("card-errors").textContent = result.error.message;
                } else {
                    const hiddenInput = document.createElement("input");
                    hiddenInput.setAttribute("type", "hidden");
                    hiddenInput.setAttribute("name", "stripeToken");
                    hiddenInput.setAttribute("value", result.token.id);
                    form.appendChild(hiddenInput);

                    htmx.ajax('POST', '/checkout/step-3/', {
                        target: '#checkout-section',
                        swap: 'outerHTML',
                        values: {
                            stripeToken: result.token.id,
                            csrfmiddlewaretoken: form.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    });
                }
            });
        });
    }
});

</script>


<script>

    //script for make your own page
    document.addEventListener("DOMContentLoaded", () => showStep("step-shape"));

    function showStep(stepId) {
        // Hide all steps
        document.querySelectorAll('.step').forEach(step => {
            step.classList.add('hidden');
        });

        // Show selected step
        document.getElementById(stepId).classList.remove('hidden');

        // Update button highlighting
        document.querySelectorAll('.step-button').forEach(btn => {
            btn.classList.remove('bg-primary/10', 'ring-2', 'ring-primary', 'font-semibold');
        });

        const activeBtn = document.querySelector(`[data-step-button="${stepId}"]`);
        if (activeBtn) {
            activeBtn.classList.add('bg-primary/10', 'ring-2', 'ring-primary', 'font-semibold');
        }
    }


   function incrementValue(inputId) {
        const input = document.getElementById(inputId);
        const currentValue = parseInt(input.value);
        const maxValue = parseInt(input.max);

        if (input && currentValue < maxValue) {
            input.value = currentValue + 1;
            input.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    function decrementValue(inputId) {
        const input = document.getElementById(inputId);
        const currentValue = parseInt(input.value);
        const minValue = parseInt(input.min);

        if (input && currentValue > minValue) {
            input.value = currentValue - 1;
            input.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
</script>

<script>
    document.body.addEventListener('htmx:configRequest', (event) => {
        const token = document.querySelector('meta[name="csrf-token"]').content;
        event.detail.headers['X-CSRFToken'] = token;
    });
</script>

<script>
    document.body.addEventListener('htmx:targetError', function(evt) {
        console.error("HTMX Target Error:", evt.detail);
    });

    document.body.addEventListener('htmx:afterRequest', function(evt) {
        console.log("HTMX request completed", evt.detail);
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let salesChart, productsChart, visitorsChart, conversionChart;
let autoRefreshIntervalId = null;
let chartTypeOverrides = {};

function renderAllCharts(data, chartTypeOverrides = {}) {
  // Destroy previous charts if they exist
  if (salesChart) salesChart.destroy();
  if (productsChart) productsChart.destroy();
  if (visitorsChart) visitorsChart.destroy();
  if (conversionChart) conversionChart.destroy();

  // Use chartTypeOverrides to set type for each chart
  salesChart = new Chart(document.getElementById("salesChart"), {
    type: chartTypeOverrides.sales || "line",
    data: {
      labels: data.sales.labels,
      datasets: [
        {
          label: "Vânzări (Lei)",
          data: data.sales.totals,
          borderColor: "rgb(59, 130, 246)",
          backgroundColor: "rgba(59, 130, 246, 0.1)",
          fill: true,
          tension: 0.4,
        }
      ]
    },
    options: { responsive: true }
  });

  productsChart = new Chart(document.getElementById("productsChart"), {
    type: chartTypeOverrides.products || "bar",
    data: {
      labels: data.top_products.labels,
      datasets: [{
        label: "Units Sold",
        data: data.top_products.data,
        backgroundColor: "rgba(34, 197, 94, 0.5)",
        borderColor: "rgba(34, 197, 94, 1)",
        borderWidth: 1
      }]
    },
    options: { responsive: true }
  });

  visitorsChart = new Chart(document.getElementById("visitorsChart"), {
    type: chartTypeOverrides.visitors || "bar",
    data: {
      labels: data.visits.labels,
      datasets: [{
        label: 'Visitors',
        data: data.visits.counts,
        backgroundColor: 'rgba(16, 185, 129, 0.5)',
        borderColor: 'rgb(5, 150, 105)',
        borderWidth: 1
      }]
    },
    options: { responsive: true }
  });

  conversionChart = new Chart(document.getElementById("conversionChart"), {
    type: chartTypeOverrides.conversion || "line",
    data: {
      labels: data.conversion.labels,
      datasets: [{
        label: 'Rata de conversie (%)',
        data: data.conversion.rates,
        borderColor: 'rgb(234, 88, 12)',
        backgroundColor: 'rgba(251, 191, 36, 0.2)',
        fill: true,
        tension: 0.4,
        yAxisID: 'y',
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: 'Rata de conversie (%)' }
        }
      }
    }
  });

  // Add compare period to sales chart if present
  if (data.compare && data.compare.labels && data.compare.totals) {
    salesChart.data.datasets.push({
      label: "Compare Period",
      data: data.compare.totals,
      borderColor: "rgb(168,85,247)",
      backgroundColor: "rgba(168,85,247,0.1)",
      fill: false,
      borderDash: [5,5],
      tension: 0.4,
    });
    salesChart.data.labels = data.sales.labels.length > data.compare.labels.length ? data.sales.labels : data.compare.labels;
    salesChart.update();
  }
}

function fetchAndRenderCharts(
   startDate, endDate, category, product, compare, chartTypes
) {
  let url = "{% url 'analytics_data' %}";
  const params = [];
  if (startDate) params.push(`start=${startDate}`);
  if (endDate) params.push(`end=${endDate}`);
  if (category) params.push(`category=${category}`);
  if (product) params.push(`product=${product}`);
  if (compare && compare.start && compare.end) {
    params.push(`compare_start=${compare.start}`);
    params.push(`compare_end=${compare.end}`);
  }
  if (params.length) url += "?" + params.join("&");
  fetch(url)
    .then(res => res.json())
    .then(data => renderAllCharts(data, chartTypes));
}


document.addEventListener("DOMContentLoaded", function () {
  // Set default date range (last 30 days)
  const endInput = document.getElementById('chart-date-end');
  const startInput = document.getElementById('chart-date-start');
  const today = new Date();
  const prior = new Date();
  prior.setDate(today.getDate() - 30);
  endInput.value = today.toISOString().slice(0,10);
  startInput.value = prior.toISOString().slice(0,10);

  // Initial fetch
  fetchAndRenderCharts(startInput.value, endInput.value);

  // Date filter button
    document.getElementById('chart-date-filter-btn').addEventListener('click', function() {
        const start = document.getElementById('chart-date-start').value;
        const end   = document.getElementById('chart-date-end').value;
        const category = document.getElementById('category-filter').value;
        const product  = document.getElementById('product-filter').value;
        // if you still have the compare inputs visible, grab those too:
        const compareStart = document.getElementById('compare-date-start').value;
        const compareEnd   = document.getElementById('compare-date-end').value;
        const compare = (compareStart && compareEnd)
            ? { start: compareStart, end: compareEnd }
            : null;

        fetchAndRenderCharts(
            start,
            end,
            category,
            product,
            null,
            chartTypeOverrides
        );
    });

    const allowedChartTypes = {
        sales: ['default', 'bar', 'line'],
        products: ['default', 'bar', 'line', 'pie'],
        visitors: ['default', 'line'],
        conversion: ['default', 'line'],
    };

    function updateChartTypeOptions(chartKey) {
        const group = document.querySelector('[data-group="chart-type"]');
        const select = document.getElementById('chart-type-select');
        const allowed = allowedChartTypes[chartKey];

        if (!allowed || allowed.length === 0) {
            group.style.display = 'none';
            return;
        }

        group.style.display = 'flex'; // or 'block' depending on layout
        select.innerHTML = '';

        allowed.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            select.appendChild(option);
        });
    }

    // Chart subject filter logic
    const chartMap = {
        sales: "chart-sales",
        products: "chart-products",
        visitors: "chart-visitors",
        conversion: "chart-conversion"
    };

  document.querySelectorAll('.chart-filter-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      document.querySelectorAll('.chart-filter-btn').forEach(b => b.classList.remove('bg-blue-200', 'font-bold'));
      this.classList.add('bg-blue-200', 'font-bold');
      const selected = this.dataset.chart;
      // Show summary cards only for sales chart
      const summary = document.getElementById('sales-summary-cards');
      if (summary) summary.style.display = (selected === "sales") ? "flex" : "none";
      // Update chart type options for the selected chart
      updateChartTypeOptions(selected);

      // Reset category and product filters when leaving "products" chart
      if (selected !== "products") {
        document.getElementById('category-filter').selectedIndex = 0;
        document.getElementById('product-filter').innerHTML = '<option value="">All</option>';
      }

      if (selected === "all") {
        Object.values(chartMap).forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = "";
        });
      } else {
        Object.entries(chartMap).forEach(([key, id]) => {
          const el = document.getElementById(id);
          if (el) el.style.display = (key === selected) ? "" : "none";
        });
      }
    });
  });

  // Category/Product filter logic
  document.getElementById('category-filter').addEventListener('change', function() {
    const cat = this.value;
    fetch("{% url 'product_list_api' %}?category=" + encodeURIComponent(cat))
      .then(res => res.json())
      .then(data => {
        const prodSel = document.getElementById('product-filter');
        prodSel.innerHTML = '<option value="">All</option>';
        data.products.forEach(p => {
          prodSel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        });
      });
    fetchAndRenderCharts(
      document.getElementById('chart-date-start').value,
      document.getElementById('chart-date-end').value,
      cat,
      "",
   
      null,
      chartTypeOverrides
    );
  });
  document.getElementById('product-filter').addEventListener('change', function() {
    fetchAndRenderCharts(
      document.getElementById('chart-date-start').value,
      document.getElementById('chart-date-end').value,
      document.getElementById('category-filter').value,
      this.value,

      null,
      chartTypeOverrides
    );
  });

  // Chart type selector
  document.getElementById('chart-type-select').addEventListener('change', function() {
    const val = this.value;
    chartTypeOverrides = {};

    if (val !== "default") {
      chartTypeOverrides = {
        sales: val,
        products: val,
        visitors: val,
        conversion: val
      };
    }
    fetchAndRenderCharts(
      document.getElementById('chart-date-start').value,
      document.getElementById('chart-date-end').value,
      document.getElementById('category-filter').value,
      document.getElementById('product-filter').value,
      null,
      chartTypeOverrides
    );
  });

  // Compare periods
  document.getElementById('compare-btn').addEventListener('click', function() {
    fetchAndRenderCharts(
      document.getElementById('chart-date-start').value,
      document.getElementById('chart-date-end').value,
      document.getElementById('category-filter').value,
      document.getElementById('product-filter').value,
      {
        start: document.getElementById('compare-date-start').value,
        end: document.getElementById('compare-date-end').value
      },
      chartTypeOverrides
    );
  });

  // Drilldown (example for salesChart)
  document.getElementById('salesChart').onclick = function(evt) {
    const points = salesChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
    if (points.length) {
      const label = salesChart.data.labels[points[0].index];
      alert("Drilldown for: " + label);
      // Optionally, fetch and display more detailed data in a modal
    }
  };

  // Initial fetch with all filters
  fetchAndRenderCharts(
    document.getElementById('chart-date-start').value,
    document.getElementById('chart-date-end').value,
    document.getElementById('category-filter').value,
    document.getElementById('product-filter').value,
    //document.getElementById('user-segment-filter').value,
    null,
    chartTypeOverrides
  );

  // Wire up chart‐filter buttons
  document.querySelectorAll('.chart-filter-btn').forEach(btn=>{
    btn.addEventListener('click', function(){
      // highlight
      document.querySelectorAll('.chart-filter-btn').forEach(b=>b.classList.remove('bg-blue-200','font-bold'));
      this.classList.add('bg-blue-200','font-bold');
      // show/hide charts
      const sel = this.dataset.chart;
      Object.entries(chartMap).forEach(([k,id])=>{
        document.getElementById(id).style.display = (sel==='all'||k===sel)?'':'none';
      });
      // show/hide filters
      const allow = this.dataset.filters.split(',').map(s=>s.trim());
      document.querySelectorAll('.filter-group').forEach(div=>{
        div.style.display = allow.includes(div.dataset.group)?'flex':'none';
      });
    });
  });

  // Initialize on “All”
  document.querySelector('[data-chart="all"]').click();
});


function updateSalesSummary(start, end) {
  fetch(`/api/sales-summary/?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`)
    .then(res => res.json())
    .then(data => {
      // Orders
      document.querySelector('#sales-summary-cards .orders-value').textContent = data.total_orders ?? "0";
      let og = document.querySelector('#sales-summary-cards .orders-growth');
      if (og) {
        if (data.orders_growth === null) {
          og.style.display = "none";
        } else {
          og.style.display = "";
          const growth = Number(data.orders_growth);
          og.innerHTML =
            (growth >= 0
              ? `<span class="flex items-center text-green-600 bg-green-50 rounded px-2 py-0.5 text-xs font-semibold">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12l5-5 5 5"></path></svg>
                  ${growth % 1 === 0 ? growth : growth.toFixed(2).replace(/\.?0+$/, '')}%
                </span>`
              : `<span class="flex items-center text-red-600 bg-red-50 rounded px-2 py-0.5 text-xs font-semibold">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 12l-5 5-5-5"></path></svg>
                  ${growth % 1 === 0 ? growth : growth.toFixed(2).replace(/\.?0+$/, '')}%
                </span>`);
        }
      }
      // Revenue
      document.querySelector('#sales-summary-cards .revenue-value').textContent = data.total_revenue ?? "0";
      let rg = document.querySelector('#sales-summary-cards .revenue-growth');
      if (rg) {
        if (data.revenue_growth === null) {
          rg.style.display = "none";
        } else {
          rg.style.display = "";
          const growth = Number(data.revenue_growth);
          rg.innerHTML =
            (growth >= 0
              ? `<span class="flex items-center text-green-600 bg-green-50 rounded px-2 py-0.5 text-xs font-semibold">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12l5-5 5 5"></path></svg>
                  ${growth % 1 === 0 ? growth : growth.toFixed(2).replace(/\.?0+$/, '')}%
                </span>`
              : `<span class="flex items-center text-red-600 bg-red-50 rounded px-2 py-0.5 text-xs font-semibold">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 12l-5 5-5-5"></path></svg>
                  ${growth % 1 === 0 ? growth : growth.toFixed(2).replace(/\.?0+$/, '')}%
                </span>`);
        }
      }
    });
}

document.addEventListener("DOMContentLoaded", function () {

  function refreshSalesSummaryIfVisible() {
    const summary = document.getElementById('sales-summary-cards');
    if (summary && summary.style.display === "flex") {
      const start = document.getElementById('chart-date-start').value;
      const end = document.getElementById('chart-date-end').value;
      updateSalesSummary(start, end);
    }
  }

  // Update summary cards when date filter or compare is used
  document.getElementById('chart-date-filter-btn').addEventListener('click', refreshSalesSummaryIfVisible);
  document.getElementById('compare-btn').addEventListener('click', refreshSalesSummaryIfVisible);

  // Also update when switching to sales chart
  document.querySelectorAll('.chart-filter-btn').forEach(btn => {
    btn.addEventListener('click', function () {

      if (this.dataset.chart === "sales") {
        refreshSalesSummaryIfVisible();
      }
    });
  });


});
</script>