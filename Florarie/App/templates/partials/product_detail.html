{% extends 'base.html' %}
{% block content %}

<div class="container mx-auto mt-24 py-32 px-8">

    <!-- Product Info -->
    <div class="flex flex-col lg:flex-row gap-10">
        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-1/2 h-100 object-cover rounded-xl shadow-lg">

        <div class="flex flex-col gap-6 w-full lg:w-1/2 bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-gray-800">{{ product.name }}</h1>
            <p class="text-gray-700 text-lg leading-relaxed">{{ product.description }}</p>
            <p class="text-3xl font-bold text-primary">{{ product.price }} Lei</p>

            <div id="add-to-cart-container-{{ product.id }}">
                {% if product.id not in cart_product_ids %}
                <form id="add-to-cart-form-{{ product.id }}" 
                      hx-post="{% url 'add_to_cart' product.id %}" 
                      class="mt-4">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary w-32 hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105">Add to Cart</button>
                </form>
                {% else %}
                <a href="/cart/" id="cart-btn" class="btn btn-success mt-2">
                    View in Cart
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Related Products Carousel -->
    <h2 class="text-2xl font-bold mt-16 mb-6">You might also like</h2>

    <div class="flex overflow-x-auto gap-6 pb-4">
        {% for item in related_products %}
            <a href="{% url 'product_detail' item.id %}" class="min-w-[200px] bg-white shadow rounded-lg p-3 hover:scale-105 duration-300">
                <img src="{{ item.image.url }}" class="w-full h-40 object-cover rounded-md mb-2">
                <h3 class="font-semibold">{{ item.name }}</h3>
                <p class="text-sm text-gray-500">{{ item.price }} Lei</p>
            </a>
        {% endfor %}
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('add-to-cart-form-{{ product.id }}');
        if (form) {
            form.addEventListener('submit', function (event) {
                event.preventDefault();
                const container = document.getElementById(`add-to-cart-container-{{ product.id }}`);
                
                // Immediately show "Already Added" div
                container.innerHTML = `<a href="/cart/" id="cart-btn" class="btn btn-success mt-2">
                        View in Cart
                    </a>`;

                const formData = new FormData(form);

                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        console.error('Failed to add to cart');
                        // Optionally revert the UI if the request fails
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Optionally revert the UI if an error occurs
                });
            });
        }
    });
</script>

{% endblock %}
