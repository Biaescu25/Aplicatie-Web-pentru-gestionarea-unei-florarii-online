<div id="cart-item-{{ cart_item.id }}" class="card-body mb-3 shadow-lg">
    
   
    <!-- Container pentru mesajele de eroare -->
    <div id="cart-item-error-{{ cart_item.id }}" class="mt-2 text-sm p-3 rounded-md bg-red-50 text-red-700 border border-red-200 flex items-center gap-2" style="display: none;">
        <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        <span class="error-text"></span>
    </div>
         
    <div class="flex justify-between items-center">
        <div class="center">
            {% if not cart_item.product.is_custom %}
            <a href="{% url 'product_detail' pk=cart_item.product.id %}">
            {% endif %}

                <img src="{{ cart_item.product.image.url }}" class="img-fluid rounded" alt="{{ cart_item.product.name }}" style="width: 100px; height: 100px; object-fit: cover;">

            {% if not cart_item.product.is_custom %}
            </a>
            {% endif %}
        </div>
        <div class="center" style="flex: 1; max-width: 200px; text-align: left; padding-right: 10px;">
            <p class="card-text font-medium truncate" style="margin: 0;">{{ cart_item.product.name }}</p>
            <p class="card-text font-medium" style="margin: 0;">{{ cart_item.product.price }} LEI</p>
             {% if cart_item.product.category not in 'CustomBouquet' %}
                {% if cart_item.product.category not in 'buchete,aranjamente' %}
                    <p class="card-text text-sm text-gray-500" style="margin: 0;">Stoc: {{ cart_item.product.stock }}</p>
                {% else %}
                    {% if not cart_item.product.bid_submited %}
                        <p class="card-text text-sm text-gray-500" style="margin: 0;">10 max</p>
                    {% else %}
                        <p class="card-text text-sm text-gray-500" style="margin: 0;">Buchetul va fi disponibil pana la {{ cart_item.reserved_until }}</p>
                    {% endif %}
                {% endif %}
             {% endif %}
        </div>

        <div class="flex items-center space-x-2">

            {% if not cart_item.product.bid_submited %}
            <button onclick="decrementQuantity({{ cart_item.product.id }}, {{ cart_item.id }})" 
               class="btn btn-primary btn-sm center bg-green-600 text-white">-</button>
            {%endif %}

            <div class="center" style="padding: 0 10px; text-align: center;">
                <p class="card-text font-bold text-lg" style="margin: 0; font-size: 1.2rem;">{{ cart_item.quantity }}</p>
            </div>

            {% if not cart_item.product.bid_submited %}
            <button onclick="incrementQuantity({{ cart_item.product.id }}, {{ cart_item.id }})" 
               class="btn btn-primary btn-sm center bg-green-600 text-white 
               {% if cart_item.product.category in 'buchete,aranjamente' %}
                   {% if cart_item.quantity >= 10 %}opacity-50 cursor-not-allowed pointer-events-none{% endif %}
               {% else %}
                   {% if cart_item.quantity >= cart_item.product.stock %}opacity-50 cursor-not-allowed pointer-events-none{% endif %}
               {% endif %}">+</button>
            {%endif %}

             

        </div>
        <div class="center" style="min-width: 120px; text-align: right;">
            <p class="card-text">Subtotal: {{ cart_item.total_price }} LEI </p>
        </div>
        <div class="center">
            <a href="{% url 'remove_from_cart' product_id=cart_item.product.id %}" 
               class="btn btn-danger btn-sm"
               hx-get="{% url 'remove_from_cart' product_id=cart_item.product.id %}" 
               hx-target="#cart-item-{{ cart_item.id }}" 
               hx-swap="outerHTML">È˜terge</a>
        </div>
    </div>
</div>

<script>
function incrementQuantity(productId, cartItemId) {
    const errorContainer = document.getElementById(`cart-item-error-${cartItemId}`);
    const cartItemElement = document.getElementById(`cart-item-${cartItemId}`);

    // Sterge mesajele de eroare existente
    if (errorContainer) {
        errorContainer.style.display = 'none';
        errorContainer.innerHTML = '';
    }
    
    fetch(`/cart/increment/${productId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'HX-Request': 'true'  // Adauga header-ul HTMX pentru a obtine raspuns HTMX
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(errorText => {
                throw new Error(errorText);
            });
        }
        return response.text();
    })
    .then(html => {
        // Inlocuieste doar elementul cosului cu noul HTML
        cartItemElement.outerHTML = html;

        // Update trigger pentru pretul total
        document.body.dispatchEvent(new CustomEvent('updateTotalPrice'));
    })
    .catch(error => {
        console.error("Eroare la incrementare:", error.message);
        // Display error message
        if (errorContainer) {
            const errorTextSpan = errorContainer.querySelector('.error-text');
            if (errorTextSpan) {
                errorTextSpan.innerHTML = error.message;
            } else {
                errorContainer.innerHTML = error.message;
            }
            errorContainer.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorContainer.style.display = 'none';
            }, 5000);
        }
    });
}

function decrementQuantity(productId, cartItemId) {
    const errorContainer = document.getElementById(`cart-item-error-${cartItemId}`);
    const cartItemElement = document.getElementById(`cart-item-${cartItemId}`);
    
    // Sterge mesajele de eroare existente
    if (errorContainer) {
        errorContainer.style.display = 'none';
        errorContainer.innerHTML = '';
    }
    
    fetch(`/cart/decrement/${productId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'HX-Request': 'true'  // Adauga header-ul HTMX pentru a obtine raspuns HTMX
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(errorText => {
                throw new Error(errorText);
            });
        }
        return response.text();
    })
    .then(html => {
        // Verifica daca HTML-ul este gol (elementul ar fi putut fi sters)
        if (html.trim() === "") {
            // Elementul a fost sters, reincarca pagina pentru a actualiza totul
            window.location.reload();
        } else {
            // Inlocuieste doar elementul cosului cu noul HTML
            cartItemElement.outerHTML = html;

            // Update trigger pentru pretul total
            document.body.dispatchEvent(new CustomEvent('updateTotalPrice'));
        }
    })
    .catch(error => {
        console.error("Eroare la decrementare:", error.message);
        // Afiseaza mesajul de eroare
        if (errorContainer) {
            const errorTextSpan = errorContainer.querySelector('.error-text');
            if (errorTextSpan) {
                errorTextSpan.innerHTML = error.message;
            } else {
                errorContainer.innerHTML = error.message;
            }
            errorContainer.style.display = 'block';

            // Auto-hide dupa 5 sec
            setTimeout(() => {
                errorContainer.style.display = 'none';
            }, 5000);
        }
    });
}
</script>
