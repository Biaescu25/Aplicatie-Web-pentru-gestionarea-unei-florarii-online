{% extends "base.html" %}

{% block content %}
<section class="relative w-full h-56 bg-cover bg-center mt-14" style="background-image: url('/static/bannerCart.jpg');">
    <div class="absolute inset-0 bg-black opacity-50"></div>
    <div class="container mx-auto px-4 py-16 relative z-10 text-white">
        <h1 class="text-4xl font-bold text-center mt-16">Bouquet Builder</h1>
    </div>
</section>  

<section class="pt-8 bg-gray-50 h-full">
    <div class="container mx-auto px-2 max-w-4xl">
        <h1 class="text-3xl font-bold mb-6 text-center mt-12">Crează-ți propriul buchet</h1>

        <div class="grid grid-cols-12 gap-6">
            <!-- Sidebar -->
            <div class="col-span-3 space-y-2 sticky top-32">
                <button type="button" data-step-button="step-shape" onclick="showStep('step-shape')" class="step-button block w-full text-left px-4 py-2 bg-white rounded shadow hover:bg-primary/10">Forma buchetului</button>
                <button type="button" data-step-button="step-flowers" onclick="showStep('step-flowers')" class="step-button block w-full text-left px-4 py-2 bg-white rounded shadow hover:bg-primary/10">Florile</button>
                <button type="button" data-step-button="step-greenery" onclick="showStep('step-greenery')" class="step-button block w-full text-left px-4 py-2 bg-white rounded shadow hover:bg-primary/10">Verdeață</button>
                <button type="button" data-step-button="step-wrapping" onclick="showStep('step-wrapping')" class="step-button block w-full text-left px-4 py-2 bg-white rounded shadow hover:bg-primary/10">Ambalaj</button>
            </div>

            <!-- Content area -->
            <form id="bouquet-form" 
                hx-post="{% url 'create_custom_bouquet' %}" 
                hx-target="#summary" 
                hx-swap="innerHTML"
                hx-trigger="change, keyup delay:300ms from:input, select"
                class="col-span-9 bg-white p-6 rounded-lg shadow overflow-y-auto h-[calc(2*12rem+1rem)]">

            {% csrf_token %}

                <!-- SHAPE SECTION -->
                <div id="step-shape" class="step hidden space-y-8">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    {% for shape in shapes %}
                    <div class="relative">
                        <input type="radio" name="shape" value="{{ shape.id }}" id="shape_{{ shape.id }}" class="hidden peer" required>
                        <label for="shape_{{ shape.id }}"
                            class="cursor-pointer border rounded p-1 hover:shadow transition 
                                    peer-checked:ring-2 peer-checked:ring-primary peer-checked:border-primary block">
                        <img src="{{ shape.image.url }}" alt="{{ shape.name }}" class="w-full h-24 object-cover rounded">
                        <p class="text-center mt-1 text-sm font-medium">{{ shape.name }}</p>
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                </div>

                <!-- FLOWERS SECTION -->
                <div id="step-flowers" class="step hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {% for flower in flowers %}
                        <div class="border rounded p-2 hover:shadow transition">
                            <img src="{{ flower.image.url }}" alt="{{ flower.name }}" class="w-full h-24 object-cover rounded">
                            <div class="mt-1 text-center">
                                <p class="text-sm font-medium">{{ flower.name }}</p>
                                <p class="text-xs text-gray-600">{{ flower.price }} LEI</p>
                                <div class="flex items-center justify-center mt-2">
                                    <button type="button" class="px-2 py-1 bg-gray-200 rounded-l hover:bg-gray-300" onclick="decrementValue('flower_{{ flower.id }}')">-</button>
                                    <input type="number" name="flower_{{ flower.id }}" id="flower_{{ flower.id }}" min="0" max="100" value="0" 
                                           class="w-12 text-center border-t border-b border-gray-300 focus:outline-none">
                                    <button type="button" class="px-2 py-1 bg-gray-200 rounded-r hover:bg-gray-300" onclick="incrementValue('flower_{{ flower.id }}')">+</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- GREENERY SECTION -->
                <div id="step-greenery" class="step hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    {% for green in greens %}
                    <div class="relative">
                        <input type="checkbox" name="greens" value="{{ green.id }}" id="green_{{ green.id }}" class="hidden peer">
                        <label for="green_{{ green.id }}" 
                            class="cursor-pointer border rounded p-2 hover:shadow transition block 
                                    peer-checked:ring-2 peer-checked:ring-success peer-checked:border-success">
                        <img src="{{ green.image.url }}" alt="{{ green.name }}" class="w-full h-20 object-cover rounded">
                        <p class="text-center mt-1 text-sm font-medium">{{ green.name }} ({{ green.price }} LEI)</p>
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                </div>

                <!-- WRAPPING SECTION -->
                <div id="step-wrapping" class="step hidden">

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    {% for wrap in wrappings %}
                    <div class="relative">
                        <input type="radio" name="wrapping" value="{{ wrap.id }}" id="wrap_{{ wrap.id }}" class="hidden peer">
                        <label for="wrap_{{ wrap.id }}" 
                            class="cursor-pointer border rounded p-2 hover:shadow transition block 
                                    peer-checked:ring-2 peer-checked:ring-success peer-checked:border-success">
                        <img src="{{ wrap.image.url }}" alt="{{ wrap.name }}" class="w-full h-20 object-cover rounded">
                        <p class="text-center mt-1 text-sm font-medium">{{ wrap.name }} ({{ wrap.price }} LEI)</p>
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                </div>
            </form>

        </div>

        <!-- SUMMARY -->
        <div class="flex flex-col md:flex-row gap-6 mt-4">
            <div id="summary" class="bg-gray-100 p-3 rounded md:w-1/2">
                <div class="text-gray-500 text-xs text-center">Selectează opțiuni pentru a vedea sumarul buchetului</div>
            </div>
            <div class="md:w-1/2 flex flex-col items-center">
                <h2 class="text-lg font-semibold mb-2">Preview buchet:</h2>
                <div class="relative w-full max-w-2xl h-[20rem] flex items-center justify-center bg-gradient-to-br from-pink-50 via-white to-green-50 border rounded-lg shadow-lg overflow-hidden">
                    <img id="bouquet-preview" src="" alt="Preview buchet"
                         class="object-contain w-full h-full transition-opacity duration-500 opacity-80 hover:opacity-100 drop-shadow-lg" />
                    <div id="bouquet-preview-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none" style="display: none;">
                        <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 48 48">
                            <ellipse cx="24" cy="32" rx="14" ry="8" stroke="currentColor" fill="none"/>
                            <path d="M24 32V10" stroke="currentColor" stroke-linecap="round"/>
                            <circle cx="24" cy="10" r="4" stroke="currentColor" fill="none"/>
                        </svg>
                        <span class="text-lg">Aici va apărea previzualizarea buchetului</span>
                    </div>
                </div>
                <script>
                const previewImg = document.getElementById("bouquet-preview");
                const placeholder = document.getElementById("bouquet-preview-placeholder");
                function toggleBouquetPlaceholder() {
                    if (!previewImg.src || previewImg.src.endsWith('/')) {
                        placeholder.style.display = "";
                        previewImg.style.opacity = 0;
                    } else {
                        placeholder.style.display = "none";
                        previewImg.style.opacity = 1;
                    }
                }
                previewImg.addEventListener("load", toggleBouquetPlaceholder);
                toggleBouquetPlaceholder();
                </script>
            </div>
        </div>
  
    </div>
</section>
  



<script>
function updateBouquetPreview() {
    console.log("triggered"); // DEBUG
    
  const flowerInputs = document.querySelectorAll("input[name^='flower_']");
  const flowers = Array.from(flowerInputs).map(input => ({
    id: parseInt(input.name.replace("flower_", "")),
    count: parseInt(input.value || "0")
  })).filter(f => f.count > 0);

  const shape = document.querySelector("input[name='shape']:checked")?.value;
  const wrapping = document.querySelector("input[name='wrapping']:checked")?.value;
  const greens = Array.from(document.querySelectorAll("input[name='greens']:checked")).map(g => g.value);

  if (!shape || !wrapping || greens.length === 0 || flowers.length === 0) return;

  const data = {
    shape: shape,
    wrapping: wrapping,
    greens: greens,
    flowers: flowers
  };

  fetch("{% url 'generate_bouquet_preview' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
  .then(res => res.blob())
  .then(blob => {
    const url = URL.createObjectURL(blob);
    document.getElementById("bouquet-preview").src = url;
  });
}

// ✅ atașează manual pe toate inputurile relevante
function attachPreviewListeners() {
  const inputs = document.querySelectorAll(
    "input[name^='flower_'], input[name='shape'], input[name='wrapping'], input[name='greens']"
  );
  inputs.forEach(input => {
    input.addEventListener("change", updateBouquetPreview);
    input.addEventListener("input", updateBouquetPreview);
  });
}

// ✅ rulează după ce HTMX reîncarcă părți de pagină
document.addEventListener("DOMContentLoaded", attachPreviewListeners);
document.addEventListener("htmx:afterSwap", attachPreviewListeners);
</script>


{% endblock %}

