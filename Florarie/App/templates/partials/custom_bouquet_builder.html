{% extends "base.html" %}

{% block content %}
<section class="relative w-full h-56 bg-cover bg-center mt-14" style="background-image: url('/static/bannerCart.jpg');">
    <div class="absolute inset-0 bg-black opacity-50"></div>
    <div class="container mx-auto px-4 py-16 relative z-10 text-white">
        <h1 class="text-4xl font-bold text-center mt-16">Creează-ți propriul buchet</h1>
    </div>
</section>  

<section class="pt-8 bg-gray-50 h-full mb-10">
    <div class="container mx-auto px-2 max-w-4xl">


        <div class="grid grid-cols-12 gap-6">
            <!-- Sidebar -->
            <div class="col-span-3 space-y-2 sticky top-32">
                <button type="button" data-step-button="step-shape" onclick="showStep('step-shape')" class="step-button block w-full text-left px-4 py-2 bg-white rounded shadow hover:bg-primary/10">Forma buchetului</button>
                <button type="button" data-step-button="step-flowers" onclick="showStep('step-flowers')" class="step-button block w-full text-left px-4 py-2 bg-white rounded shadow hover:bg-primary/10">Florile</button>
                <button type="button" data-step-button="step-greenery" onclick="showStep('step-greenery')" class="step-button block w-full text-left px-4 py-2 bg-white rounded shadow hover:bg-primary/10">Verdeață</button>
                <button type="button" data-step-button="step-wrapping" onclick="showStep('step-wrapping')" class="step-button block w-full text-left px-4 py-2 bg-white rounded shadow hover:bg-primary/10">Ambalaj</button>
            </div>

            <!-- Content area -->
            <form id="bouquet-form" 
                hx-post="{% url 'create_custom_bouquet' %}" 
                hx-target="#summary" 
                hx-swap="innerHTML"
                hx-trigger="change, keyup delay:300ms from:input, select"
                class="col-span-9 bg-white p-6 rounded-lg shadow overflow-y-auto h-[calc(2*12rem+1rem)]">

            {% csrf_token %}

                <!-- SHAPE SECTION -->
                <div id="step-shape" class="step hidden space-y-8">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    {% for shape in shapes %}
                    <div class="relative">
                        <input type="radio" name="shape" value="{{ shape.id }}" id="shape_{{ shape.id }}" class="hidden peer" required>
                        <label for="shape_{{ shape.id }}"
                            class="cursor-pointer border rounded p-1 hover:shadow transition 
                                    peer-checked:ring-2 peer-checked:ring-primary peer-checked:border-primary block">
                        <img src="{{ shape.image.url }}" alt="{{ shape.name }}" class="w-full h-24 object-cover rounded">
                        <p class="text-center mt-1 text-sm font-medium">{{ shape.name }}</p>
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                </div>

                <!-- FLOWERS SECTION -->
                <div id="step-flowers" class="step hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {% for flower in flowers %}
                        <div class="border rounded p-2 hover:shadow transition">
                            <img src="{{ flower.image.url }}" alt="{{ flower.name }}" class="h-24 w-auto mx-auto object-contain rounded">
                            <div class="mt-1 text-center">
                                <p class="text-sm font-medium">{{ flower.name }}</p>
                                <p class="text-xs text-gray-600">{{ flower.price }} LEI</p>
                                <div class="flex items-center justify-center mt-2">
                                    <button type="button" class="px-2 py-1 bg-gray-200 rounded-l hover:bg-gray-300" onclick="decrementValue('flower_{{ flower.id }}')">-</button>
                                    <input type="number" name="flower_{{ flower.id }}" id="flower_{{ flower.id }}" min="0" max="50" value="0" 
                                           class="w-12 text-center border-t border-b border-gray-300 focus:outline-none">
                                    <button type="button" class="px-2 py-1 bg-gray-200 rounded-r hover:bg-gray-300" onclick="incrementValue('flower_{{ flower.id }}')">+</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- GREENERY SECTION -->
                <div id="step-greenery" class="step hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    {% for green in greens %}
                    <div class="relative">
                        <input type="checkbox" name="greens" value="{{ green.id }}" id="green_{{ green.id }}" class="hidden peer ">
                        <label for="green_{{ green.id }}" 
                            class="cursor-pointer border rounded p-2 hover:shadow transition block 
                                    peer-checked:ring-2 peer-checked:ring-success peer-checked:border-success">
                        <img src="{{ green.image.url }}" alt="{{ green.name }}" class="h-24 w-auto mx-auto object-contain rounded">
                        <p class="text-center mt-1 text-sm font-medium">{{ green.name }} ({{ green.price }} LEI)</p>
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                </div>

                <input type="hidden" name="wrapping_variant_id" id="wrapping_variant_id">
                <input type="hidden" name="wrapping_color_name">

               <!-- WRAPPING SECTION -->
                <div id="step-wrapping" class="step hidden">
                <label class="block text-xl font-bold text-color-black mb-4 select-none">
                    Alege un ambalaj:
                </label>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                   {% for wrap in wrappings %}
                        <div class="relative">
                            <input type="radio" name="wrapping" value="{{ wrap.id }}" id="wrap_{{ wrap.id }}" class="hidden peer" required>
                            <label for="wrap_{{ wrap.id }}" 
                                class="cursor-pointer border rounded p-2 hover:shadow transition block
                                    peer-checked:ring-2 peer-checked:ring-success peer-checked:border-success">
                                <img src="{{ wrap.image.url }}" alt="{{ wrap.name }}" class="w-full h-20 object-cover rounded">
                                <p class="text-center mt-1 text-sm font-medium">{{ wrap.name }} ({{ wrap.price }} LEI)</p>
                            </label>

                            <div class="wrap-colors hidden" data-wrap-id="{{ wrap.id }}">
                                {% for variant in wrap.color_variants.all %}
                                <label class="relative cursor-pointer group">
                                    {% if variant.in_stock %}
                                     <input
                                        type="radio"
                                        name="wrapping_color"
                                        value="{{ variant.color.hex }}"
                                        class="sr-only peer"
                                        onclick="setColorName('{{ variant.color.name }}', {{ variant.id }}')"
                                        data-color-name="{{ variant.color.name }}"
                                    />
                                    {% else %}
                                        <input
                                            type="radio"
                                            disabled
                                            class="sr-only peer"
                                        />
                                    {% endif %}

                                    <div class="w-10 h-10 rounded-full border-2 border-gray-300
                                                group-hover:scale-110 group-hover:shadow-lg
                                                peer-checked:ring-2 peer-checked:ring-success peer-checked:border-success
                                                transition transform duration-200 ease-in-out
                                                relative"
                                        title="{{ variant.color.name }}"
                                        style="background-color: {{ variant.color.hex }};">

                                        {% if not variant.in_stock %}
                                            <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center text-white font-bold text-xs rounded-full">
                                                X
                                            </div>
                                        {% endif %}
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                </div>

                <!-- Containerul FIX unde se vor afișa culorile pentru ambalajul selectat -->
                <input type="hidden" name="wrapping_color_name" id="wrapping_color_name" value="">
                <div id="wrapping-colors-container" class="mt-6 hidden">
                    <label class="block text-md font-semibold mb-2">Alege culoarea ambalajului:</label>
                    <div id="wrapping-colors" class="flex flex-wrap gap-2">
                    <!-- Culorile vor fi injectate aici -->
                    </div>
                </div>
                </div>

                <!-- Hidden inputs for shape, wrapping, greens -->
                <!-- <input type="hidden" name="shape" value="">
                <input type="hidden" name="wrapping" value="">
                <input type="hidden" name="greens" value="">     -->
            </form>

        </div>

        <!-- SUMMARY -->
        <div class="flex flex-col md:flex-row gap-6 mt-4">
            <div id="summary" class="bg-gray-100 p-3 rounded md:w-1/2">
                <div class="text-gray-500 text-xs text-center">Selectează opțiuni pentru a vedea rezumatul buchetului</div>
            </div>
            <div class="md:w-1/2 flex flex-col items-center">
                <h2 class="text-lg font-semibold mb-2">Preview buchet:</h2>
                <div class="relative w-full max-w-2xl h-[20rem] flex items-center justify-center bg-gradient-to-br from-pink-50 via-white to-green-50 border rounded-lg shadow-lg overflow-hidden">
                    <img id="bouquet-preview" src="" alt="Preview buchet"
                         class="object-contain w-full h-full transition-opacity duration-500 opacity-80 hover:opacity-100 drop-shadow-lg" />
                    <div id="bouquet-preview-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none" style="display: none;">
                        <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 48 48">
                            <ellipse cx="24" cy="32" rx="14" ry="8" stroke="currentColor" fill="none"/>
                            <path d="M24 32V10" stroke="currentColor" stroke-linecap="round"/>
                            <circle cx="24" cy="10" r="4" stroke="currentColor" fill="none"/>
                        </svg>
                        <span class="text-lg">PREVIZUALIZAREA BUCHETULUI</span>
                    </div>
                </div>
                <script>
                const previewImg = document.getElementById("bouquet-preview");
                const placeholder = document.getElementById("bouquet-preview-placeholder");
                function toggleBouquetPlaceholder() {
                    if (!previewImg.src || previewImg.src.endsWith('/')) {
                        placeholder.style.display = "";
                        previewImg.style.opacity = 0;
                    } else {
                        placeholder.style.display = "none";
                        previewImg.style.opacity = 1;
                    }
                }
                previewImg.addEventListener("load", toggleBouquetPlaceholder);
                toggleBouquetPlaceholder();
                </script>
            </div>
        </div>
  
    </div>
</section>
  



<script>
   
function updateBouquetPreview() {
    console.log("triggered"); // DEBUG
    
  const flowerInputs = document.querySelectorAll("input[name^='flower_']");
  const wrappingColor = document.querySelector('input[name="wrapping_color"]:checked')?.value||null;
  const flowers = Array.from(flowerInputs).map(input => ({
    id: parseInt(input.name.replace("flower_", "")),
    count: parseInt(input.value || "0")
  })).filter(f => f.count > 0);

  const shape = document.querySelector("input[name='shape']:checked")?.value;
  const wrapping = document.querySelector("input[name='wrapping']:checked")?.value;
  const greens = Array.from(document.querySelectorAll("input[name='greens']:checked")).map(g => g.value);

  if (!shape || flowers.length == 0) {
    document.getElementById("bouquet-preview").src = "";
    return;
  }

  const data = {
    shape: shape,
    wrapping: wrapping,
    wrapping_color: wrappingColor,
    greens: greens,
    flowers: flowers
  };

  fetch("{% url 'generate_bouquet_preview' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
  .then(res => res.blob())
  .then(blob => {
    const url = URL.createObjectURL(blob);
    document.getElementById("bouquet-preview").src = url;
  });
}

// ✅ atașează manual pe toate inputurile relevante
function attachPreviewListeners() {
  const inputs = document.querySelectorAll(
    "input[name^='flower_'], input[name='shape'], input[name='wrapping'], input[name='greens']"
  );
  inputs.forEach(input => {
    input.addEventListener("change", updateBouquetPreview);
    input.addEventListener("input", updateBouquetPreview);
  });
    const colorInputs = document.querySelectorAll("input[name='wrapping_color']");
  colorInputs.forEach(input => {
    input.addEventListener("change", updateBouquetPreview);
  });
}

// ✅ rulează după ce HTMX reîncarcă părți de pagină
document.addEventListener("DOMContentLoaded", attachPreviewListeners);
document.addEventListener("htmx:afterSwap", attachPreviewListeners);

document.addEventListener("DOMContentLoaded", () => {
  const wrappingRadios = document.querySelectorAll('input[name="wrapping"]');

  wrappingRadios.forEach(radio => {
    radio.addEventListener("change", () => {
      const wrapId = radio.value;
      const sourceColors = document.querySelector(`.wrap-colors[data-wrap-id="${wrapId}"]`);
      const targetContainer = document.getElementById("wrapping-colors");
      const wrapperBox = document.getElementById("wrapping-colors-container");

      if (sourceColors && targetContainer) {
        targetContainer.innerHTML = sourceColors.innerHTML;
        wrapperBox.classList.remove("hidden");

        // Selectează automat prima culoare fără să pornească update-ul
        const colorInputs = targetContainer.querySelectorAll("input[name='wrapping_color']");

        colorInputs.forEach(input => {
        input.addEventListener("change", () => {
            const colorName = input.getAttribute("data-color-name");
            const variantId = input.getAttribute("data-variant-id");
            setColorName(colorName, variantId);
        });
        });

        // Selectează automat prima culoare disponibilă
        const firstAvailable = [...colorInputs].find(input => !input.disabled);
        if (firstAvailable) {
        firstAvailable.checked = true;
        const colorName = firstAvailable.getAttribute("data-color-name");
        const variantId = firstAvailable.getAttribute("data-variant-id");
        setColorName(colorName, variantId);
        }


        // NU atașa event listener pentru schimbarea culorii
        // Asta oprește render-ul la schimbarea culorii
      }

      // La schimbarea ambalajului tot faci update preview
      updateBouquetPreview();
    });
  });

  // Selectare automată dacă e deja selectat la reload
  const selected = document.querySelector('input[name="wrapping"]:checked');
  if (selected) selected.dispatchEvent(new Event("change"));
});

function setColorName(name, variantId = null) {
  const colorNameInput = document.getElementById("wrapping_color_name");
  if (colorNameInput) {
    colorNameInput.value = name;
  }

  const variantIdInput = document.getElementById("wrapping_variant_id");
  if (variantIdInput && variantId !== null) {
    variantIdInput.value = variantId;
  }
}
</script>

{% endblock %}

