{% extends 'base.html' %}

{% block content %}
<section class="relative w-full h-56 bg-cover bg-center mt-14" style="background-image: url('/static/bannerCart.jpg');">
    <div class="absolute inset-0 bg-black opacity-50"></div>
    <div class="container mx-auto px-4 py-16 relative z-10 text-white">
        <h1 class="text-4xl font-bold text-center mt-16">{{ category|title }}</h1>
    </div>
</section>  
<p class="text-center mt-9 text-xl italic font-bold text-gray-800 font-serif">„O floare vorbește despre frumusețe fără a rosti vreun cuvânt."</p>
<section class="container mx-auto mt-10 px-4 py-8">
    <form method="GET" class="text-center mb-8" hx-get="{% url 'products_by_category' category=category %}" hx-target="#productShowcase" hx-swap="innerHTML" hx-push-url="false">
        <div class="flex items-center bg-gray-100 justify-center mb-6 space-x-4">
            <div class="w-[400px] bg-gray-100">
            <div class="relative mt-4 slider-container">
                <!-- Custom Range Inputs -->
                <input type="range" id="minRange" name="min_price" min="{{ smallest_price }}" max="{{ largest_price }}"
                   value="{{ request.GET.min_price|default:smallest_price }}" class="range-input">
                <input type="range" id="maxRange" name="max_price" min="{{ smallest_price }}" max="{{ largest_price }}"
                   value="{{ request.GET.max_price|default:largest_price }}" class="range-input">
                    
                <!-- Custom Track -->
                <div class="relative w-full h-1 bg-gray-200 rounded-md">
                    <div id="rangeTrack" class="absolute bg-black h-1 rounded-md"></div>
                </div>
            </div>
            
            <div class="flex justify-between mt-2 text-sm text-gray-600">
                <span>LEI <span id="minValue">{{ smallest_price }}</span></span>
                <span>LEI <span id="maxValue">{{ largest_price }}</span></span>
            </div>
            </div>

            <div>
            <label for="sort" class="mr-2">Ordonare preț:</label>
            <select name="sort" id="sort" class="border rounded p-2"
                    hx-get="{% url 'products_by_category' category=category %}"
                    hx-target="#productShowcase"
                    hx-include="closest form"
                    hx-swap="innerHTML"
                    hx-push-url="false"
                    hx-trigger="change">     
                <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Crescător</option>
                <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descrescător</option>
            </select>
            </div>
        </div>
        <hr>
      </form>

      <div id="productShowcase">
        {% if products %}
            {% include 'partials/ProductShowcase.html' with products=products category=category cart_product_ids=cart_product_ids %}
        {% else %}
            <div class="text-center text-gray-600 mt-10">
                <p>No products found in the selected price range.</p>
            </div>
        {% endif %}
    </div>
</section>

<script>
    const minRange = document.getElementById("minRange");
    const maxRange = document.getElementById("maxRange");
    const minValueElement = document.getElementById("minValue");
    const maxValueElement = document.getElementById("maxValue");
    const rangeTrack = document.getElementById("rangeTrack");
    const minGap = 10;

    // Ia pretul minim si maxim
    const smallestPrice = parseInt(minRange.min);
    const largestPrice = parseInt(maxRange.max);

    function updateRange(event) {
        // Preluam valorile curente ale sliderelor
        let min = parseInt(minRange.value);
        let max = parseInt(maxRange.value);

        // Verifica daca intervalul este prea mic
        if (max - min < minGap) {
            if (event.target === minRange) {
                min = max - minGap;
                minRange.value = min;
            } else {
                max = min + minGap;
                maxRange.value = max;
            }
        }

        // Actualizeaza valorile afisate
        minValueElement.innerText = min;
        maxValueElement.innerText = max;

        // Actualizeaza pozitia si latimea intervalului
        const rangeWidth = largestPrice - smallestPrice; // Latimea intervalului
        const minPercent = ((min - smallestPrice) / rangeWidth) * 100;
        const maxPercent = ((max - smallestPrice) / rangeWidth) * 100;

        rangeTrack.style.left = `${minPercent}%`;
        rangeTrack.style.width = `${maxPercent - minPercent}%`;
    }

    function submitFormWithHTMX() {
        const form = document.querySelector("form");
        htmx.trigger(form, "submit");
    }
    // Atașează ascultători de evenimente pentru schimbările de input
    minRange.addEventListener("input", updateRange);
    maxRange.addEventListener("input", updateRange);

    // Trimite formularul doar când utilizatorul eliberează sliderul
    minRange.addEventListener("change", submitFormWithHTMX);
    maxRange.addEventListener("change", submitFormWithHTMX);

    // Initializeaza UI-ul la incarcare
    updateRange({ target: minRange });
</script>
{% endblock %}
